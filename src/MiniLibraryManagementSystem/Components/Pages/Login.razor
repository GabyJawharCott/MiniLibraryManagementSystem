@page "/"
@page "/login"
@rendermode InteractiveServer
@layout Layout.LoginLayout
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthState
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Welcome â€” Mini Library Management System</PageTitle>

<div class="text-center" style="max-width: 380px;">
    <h1 class="mb-3">Mini Library Management System</h1>
    <p class="text-muted mb-4">Sign in to continue</p>
    @if (Message is { Length: > 0 })
    {
        <div class="alert alert-warning">@Message</div>
    }
    <div class="d-flex flex-column gap-2">
        <a href="Account/ExternalLogin?provider=Google&returnUrl=@Uri.EscapeDataString(ReturnUrl ?? "")" class="btn btn-outline-danger btn-lg">Sign in with Google</a>
        @if (_isAuthenticated)
        {
            <a href="/dashboard" class="btn btn-link">Already signed in? Go to dashboard</a>
        }
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "message")]
    public string? Message { get; set; }

    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    private bool _isAuthenticated;

    protected override async Task OnInitializedAsync()
    {
        // Prefer message from current HTTP request (reliable after server redirect)
        var msgFromRequest = HttpContextAccessor.HttpContext?.Request.Query["message"].ToString();
        if (!string.IsNullOrWhiteSpace(msgFromRequest))
            Message = msgFromRequest;
        else
            ParseMessageFromUri();
        var state = await AuthState.GetAuthenticationStateAsync();
        _isAuthenticated = state.User.Identity?.IsAuthenticated == true;
    }

    private void ParseMessageFromUri()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("message", out var values) && values.Count > 0)
            Message = values[0];
    }
}
